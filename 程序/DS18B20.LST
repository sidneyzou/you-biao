C51 COMPILER V9.51   DS18B20                                                               05/08/2015 22:55:53 PAGE 1   


C51 COMPILER V9.51, COMPILATION OF MODULE DS18B20
OBJECT MODULE PLACED IN DS18B20.OBJ
COMPILER INVOKED BY: d:\Keil\C51\BIN\C51.EXE DS18B20.c LARGE OPTIMIZE(9,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          /**********************DS18B20函数文件*********************************
   2          *  晶振:12MHZ
   3          ******************************************************************/
   4          
   5          /**********************包含文件*******************/
   6          #include "DS18B20.h"
   7          /********************************全局变量初始化********************************/ 
   8          
   9          
  10          /******************************************************************************/
  11          /* 函数名称  : DSRESTET                                                       */
  12          /* 函数描述  : DS18B20发送控制信号                                            */
  13          /* 输入参数  : void                                                           */
  14          /* 参数描述  : 无                                                             */
  15          /* 返回值    : 无                                                             */
  16          /******************************************************************************/
  17          void DSRESTET(void)       //发送控制信号
  18          {
  19   1        uint i;
  20   1        DS = 0;
  21   1        i = 103;
  22   1        while(i > 0)i--;
  23   1        DS = 1;
  24   1        i = 4;
  25   1        while(i > 0)i--;
  26   1      }
  27          /******************************************************************************/
  28          /* 函数名称  : TMP_READB                                                      */
  29          /* 函数描述  : DS18B20读取一位数据                                            */
  30          /* 输入参数  : void                                                           */
  31          /* 参数描述  : 无                                                             */
  32          /* 返回值    : 无                                                             */
  33          /******************************************************************************/
  34          bit TMP_READB(void)       //读取每一位数据
  35          {
  36   1         uint i;
  37   1         bit dat;
  38   1         DS = 0;i++;          //i++ 延时
  39   1         DS = 1;i++;i++;
  40   1         dat = DS;
  41   1         i = 8;while(i>0)i--;
  42   1         return (dat);
  43   1      }
  44          /******************************************************************************/
  45          /* 函数名称  : TMP_READC                                                      */
  46          /* 函数描述  : DS18B20读取一字节数据                                          */
  47          /* 输入参数  : void                                                           */
  48          /* 参数描述  : 无                                                             */
  49          /* 返回值    : 无                                                             */
  50          /******************************************************************************/
  51          uchar TMP_READC(void)   //读一字节数据
  52          {
  53   1        uchar i,j,dat;
  54   1        dat = 0;
  55   1        for(i = 1;i <= 8;i++)
C51 COMPILER V9.51   DS18B20                                                               05/08/2015 22:55:53 PAGE 2   

  56   1        {
  57   2          j = TMP_READB();
  58   2          dat = (j<<7)|(dat>>1);   //移位储存
  59   2        }
  60   1        return(dat);
  61   1      }
  62          /******************************************************************************/
  63          /* 函数名称  : TMP_READROM                                                    */
  64          /* 函数描述  : DS18B20未知                                                    */
  65          /* 输入参数  : void                                                           */
  66          /* 参数描述  : 无                                                             */
  67          /* 返回值    : 无                                                             */
  68          /******************************************************************************/
  69          void TMP_READROM(void)          //读取数据
  70          {
  71   1        uchar sn1,sn2;
  72   1        DSRESTET();
  73   1        TMP_Delay(2);
  74   1        TMP_WRITEC(0x33);
  75   1        sn1 = TMP_READC();
  76   1        sn2 = TMP_READC();
  77   1      }
  78          
  79          /******************************************************************************/
  80          /* 函数名称  : TMP_WRITEC                                                     */
  81          /* 函数描述  : DS18B20写入每字节                                              */
  82          /* 输入参数  : void                                                           */
  83          /* 参数描述  : 无                                                             */
  84          /* 返回值    : 无                                                             */
  85          /******************************************************************************/
  86          void TMP_WRITEC(uchar dat)   //写入每字节进18B20
  87          {
  88   1        uint i;
  89   1        uchar j;
  90   1        bit testb;
  91   1        for(j = 1; j <= 8; j++)
  92   1        {
  93   2          testb = dat&0x01;
  94   2          dat = dat>>1;
  95   2          if(testb)     //write 1
  96   2          {
  97   3            DS = 0;
  98   3            i++;i++;
  99   3            DS = 1;
 100   3            i = 8;while(i > 0)i--;
 101   3          }     
 102   2          else
 103   2          {
 104   3            DS = 0;       //write 0
 105   3            i = 8;while(i > 0)i--;
 106   3            DS = 1;
 107   3            i++;i++;
 108   3          }
 109   2        
 110   2        }
 111   1      }
 112          /******************************************************************************/
 113          /* 函数名称  : TMP_CHANGE                                                     */
 114          /* 函数描述  : DS18B20发送控制信号                                            */
 115          /* 输入参数  : void                                                           */
 116          /* 参数描述  : 无                                                             */
 117          /* 返回值    : 无                                                             */
C51 COMPILER V9.51   DS18B20                                                               05/08/2015 22:55:53 PAGE 3   

 118          /******************************************************************************/
 119          void TMP_CHANGE(void)  //开始温度记录和数据转换
 120          {
 121   1        DSRESTET();
 122   1        TMP_Delay(1);
 123   1        TMP_WRITEC(0xcc);  // 
 124   1        TMP_WRITEC(0x44);  //  写温度转换指令
 125   1      }
 126          /******************************************************************************/
 127          /* 函数名称  : TMP                                                            */
 128          /* 函数描述  : DS18B20温度采集函数                                            */
 129          /* 输入参数  : void                                                           */
 130          /* 参数描述  : 无                                                             */
 131          /* 返回值    : unsigned int  温度值                                           */
 132          /******************************************************************************/
 133          uint TMP(void)               //读寄存器数据和数值转换
 134          {
 135   1        float tt;
 136   1        uint temp;
 137   1        uchar a,b;
 138   1        TMP_CHANGE();
 139   1        DSRESTET();    //发送控制信号
 140   1        TMP_Delay(1);
 141   1        TMP_WRITEC(0xcc);  //写入数据
 142   1        TMP_WRITEC(0xbe);
 143   1        a = TMP_READC();       //读取数据
 144   1        b = TMP_READC();
 145   1        temp = b;
 146   1        temp <<= 8;             //两字节计算温度
 147   1        temp = temp | a;
 148   1        tt = temp * 0.0625;
 149   1        temp = tt * 10 + 0.5;
 150   1        return temp;
 151   1      }
 152          
 153          /******************************************************************************/
 154          /* 函数名称  : TMP_Delay                                                      */
 155          /* 函数描述  : 延时XMS ms                                                     */
 156          /* 输入参数  : unsigned int                                                   */
 157          /* 参数描述  : 延时毫秒数                                                     */
 158          /* 返回值    : 无                                                             */
 159          /******************************************************************************/
 160          void TMP_Delay(uint xms)
 161          {
 162   1        uchar i;
 163   1        for( ; xms > 0; xms--)
 164   1          for(i = 120; i > 0; i--);
 165   1      }
 166          
 167          


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    338    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----       6
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----       2
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
